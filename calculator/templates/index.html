{% load static %}

<!DOCTYPE html>
<html>
<head>
<title>Airbnb Calculator</title>
<link rel="stylesheet" type="text/css" href="{% static 'css/main.css' %}"/>
<link href='https://fonts.googleapis.com/css?family=Roboto:400,300,100' rel='stylesheet' type='text/css'>
</head>
<body>

<div class="row">
  <div class="col-2 calculator-section">
    <div class="calculator">
      <h1>How much can <span class="rausch-text">Airbnb</span> help pay rent?</h1>
      <div class="row calc-function">
        <div class="row">
          <input id="zipcode-input" class="zipcode-input" type="text" placeholder="Zipcode (e.g. 19104)"/>
        </div>
        <div class="row">
          <div class="col-7 result-title">
            Typical monthly Rent<sup>*</sup>
          </div>
          <div class="col-3">
            <div class="calc-av" id="monthly-rent">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-7 result-title">
            Nightly <span class="rausch-text">Airbnb</span> Earnings<sup>**</sup>
          </div>
          <div class="col-3">
            <div class="calc-av" id="airbnb-earnings">
            </div>
          </div>
        </div>
        <div class="nights-calc">
          <div class="nights-title">Number of nights to cover rent</div>
          <hr>
          <div class="row">
            <div class="col-2 nights-percent">
              10% of rent =
            </div>
            <div class="col-2 nights" id="ten-nights">
            </div>
          </div>
          <div class="row">
            <div class="col-2 nights-percent">
              30% of rent =
            </div>
            <div class="col-2 nights" id="thirty-nights">
            </div>
          </div>
          <div class="row">
            <div class="col-2 nights-percent">
              50% of rent =
            </div>
            <div class="col-2 nights" id="fifty-nights">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-2" id="map"></div>
</div>

<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDX7TibNfGL3O6opAcUYUXMoNC-MasTr5U&callback=initMap" async defer></script>
<script>
  var map;
  var marker = null;

  function initMap() {
    geocoder = new google.maps.Geocoder();
    map = new google.maps.Map(document.getElementById('map'), {
      center: {lat: 38.901291, lng: -77.037206},
      zoom: 12
    });
    var layer = new google.maps.FusionTablesLayer({
      query: {
        select: 'geometry',
        from: '1Lae-86jeUDLmA6-8APDDqazlTOy1GsTXh28DAkw',
        where: "STATE = 'DC'"
      },
      styles: [{
        polygonOptions: {
          fillColor: '#00A699',
          fillOpacity: 0.15
        }
      }, {
        where: 'POP2001 > 10000',
        polygonOptions: {
          fillColor: '#00A699',
          fillOpacity: 0.3
        }
      }, {
        where: 'POP2001 > 50000',
        polygonOptions: {
          fillColor: '#00A699',
          fillOpacity: 0.5
        }
      }]
    });
    layer.setMap(map);
  }

  $(document).ready(function() {

    clearResults()

    $('#zipcode-input').on('input', function() {

      clearResults()

      if ($(this).val().length == 5 && /^\d+$/.test($(this).val())) {
        if (marker != null)
          marker.setMap(null);
        var zipcode_str = $(this).val();
        var zipcode = parseInt($(this).val());

        $.ajax({
          url: "/get_zipcode",
          type: "get",
          data: { zipcode: zipcode },
          success: function(result){
            if (result) {
              zipcode_data = result[0].fields;
              updateResults(
                "$" + zipcode_data.monthly_rent,
                "$" + zipcode_data.nightly_rev,
                "\u00a0" + Math.round((zipcode_data.payoff_nights*0.1)*10)/10  + " nights on Airbnb",
                "\u00a0" + Math.round((zipcode_data.payoff_nights*0.3)*10)/10  + " nights on Airbnb",
                "\u00a0" + Math.round((zipcode_data.payoff_nights*0.5)*10)/10 + " nights on Airbnb"
              );
              // geocodeZipcode(zipcode_data.zipcode.toString())
              geocodeZipcode(zipcode_str);
              console.log(zipcode_data);
            }
          }
        });
      }
    });

    function clearResults() {
      updateResults("---", "---", "\u00a0?", "\u00a0?", "\u00a0?");
    }

    function updateResults(monthly_rent, airbnb_earnings, ten, thirty, fifty) {
      $('#monthly-rent').text(monthly_rent);
      $('#airbnb-earnings').text(airbnb_earnings);
      $('#ten-nights').text(ten);
      $('#thirty-nights').text(thirty);
      $('#fifty-nights').text(fifty);
    }

    function geocodeZipcode(zipcode) {
      geocoder.geocode( { 'address': zipcode}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          map.setCenter(results[0].geometry.location);
          marker = new google.maps.Marker({
              map: map,
              position: results[0].geometry.location
          });
          if (results[0].geometry.viewport)
            map.fitBounds(results[0].geometry.viewport);
        }
      });
    }
  });

</script>

<div id="map"></div>

</body>
</html>
